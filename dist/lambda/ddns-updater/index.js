import { EC2Client, DescribeInstancesCommand } from "@aws-sdk/client-ec2";
import { SSMClient, GetParameterCommand } from "@aws-sdk/client-ssm";
// Initialize AWS clients at module level
const ec2Client = new EC2Client({});
const ssmClient = new SSMClient({});
// Load configuration
function loadConfig() {
    const parameterStorePrefix = process.env.PARAMETER_STORE_PREFIX;
    const cloudflareZoneId = process.env.CLOUDFLARE_ZONE_ID;
    const cloudflareRecordId = process.env.CLOUDFLARE_RECORD_ID;
    const validLogLevels = [
        "debug",
        "info",
        "warn",
        "error",
    ];
    const rawLogLevel = process.env.LOG_LEVEL ?? "info";
    const logLevel = validLogLevels.includes(rawLogLevel)
        ? rawLogLevel
        : "info";
    if (!parameterStorePrefix || !cloudflareZoneId || !cloudflareRecordId) {
        throw new Error("Missing required environment variables");
    }
    return {
        parameterStorePrefix,
        cloudflareZoneId,
        cloudflareRecordId,
        logLevel,
    };
}
const config = loadConfig();
// Logger utility
function log(level, message, data) {
    const levels = ["debug", "info", "warn", "error"];
    const configLevelIndex = levels.indexOf(config.logLevel);
    const messageLevelIndex = levels.indexOf(level);
    if (messageLevelIndex >= configLevelIndex) {
        console.log(JSON.stringify({
            level,
            message,
            ...data,
            timestamp: new Date().toISOString(),
        }));
    }
}
// Get parameter from Parameter Store
async function getParameter(name) {
    const command = new GetParameterCommand({
        Name: name,
        WithDecryption: true,
    });
    const response = await ssmClient.send(command);
    if (!response.Parameter?.Value) {
        throw new Error(`Parameter not found: ${name}`);
    }
    return response.Parameter.Value;
}
// Get EC2 instance public IP
async function getInstancePublicIp(instanceId) {
    log("debug", "Getting public IP for instance", { instanceId });
    const command = new DescribeInstancesCommand({
        InstanceIds: [instanceId],
    });
    const response = await ec2Client.send(command);
    const instance = response.Reservations?.[0]?.Instances?.[0];
    if (!instance) {
        throw new Error(`Instance not found: ${instanceId}`);
    }
    const publicIp = instance.PublicIpAddress;
    if (!publicIp) {
        throw new Error(`Instance ${instanceId} does not have a public IP`);
    }
    log("info", "Retrieved instance public IP", { instanceId, publicIp });
    return publicIp;
}
// Update Cloudflare DNS record
async function updateCloudflareRecord(ip) {
    log("info", "Updating Cloudflare DNS record", {
        zoneId: config.cloudflareZoneId,
        recordId: config.cloudflareRecordId,
        ip,
    });
    // Get Cloudflare API token from Parameter Store
    const apiToken = await getParameter(`${config.parameterStorePrefix}/cloudflare-token`);
    const url = `https://api.cloudflare.com/client/v4/zones/${config.cloudflareZoneId}/dns_records/${config.cloudflareRecordId}`;
    const response = await fetch(url, {
        method: "PATCH",
        headers: {
            Authorization: `Bearer ${apiToken}`,
            "Content-Type": "application/json",
        },
        body: JSON.stringify({
            content: ip,
        }),
    });
    if (!response.ok) {
        const errorBody = await response.text();
        throw new Error(`Cloudflare API error: ${response.status} - ${errorBody}`);
    }
    const data = (await response.json());
    if (!data.success) {
        throw new Error(`Cloudflare API failed: ${JSON.stringify(data.errors)}`);
    }
    log("info", "Cloudflare DNS record updated successfully", {
        recordName: data.result.name,
        content: data.result.content,
    });
    return data.result;
}
// Retry utility
async function withRetry(operation, maxAttempts = 3, baseDelayMs = 1000) {
    let lastError;
    for (let attempt = 1; attempt <= maxAttempts; attempt++) {
        try {
            return await operation();
        }
        catch (error) {
            lastError = error instanceof Error ? error : new Error(String(error));
            log("warn", `Operation failed, attempt ${attempt}/${maxAttempts}`, {
                error: lastError.message,
            });
            if (attempt < maxAttempts) {
                const delay = baseDelayMs * Math.pow(2, attempt - 1);
                await new Promise((resolve) => setTimeout(resolve, delay));
            }
        }
    }
    throw lastError;
}
// Main handler
export const handler = async (event, context) => {
    log("info", "EC2 state change event received", {
        requestId: context.awsRequestId,
        instanceId: event.detail["instance-id"],
        state: event.detail.state,
    });
    try {
        const instanceId = event.detail["instance-id"];
        // Only process running state
        if (event.detail.state !== "running") {
            log("info", "Ignoring non-running state", { state: event.detail.state });
            return;
        }
        // Get current managed instance ID from Parameter Store
        const managedInstanceId = await getParameter(`${config.parameterStorePrefix}/instance-id`);
        // Only update DNS for our managed instance
        if (managedInstanceId !== instanceId) {
            log("info", "Ignoring unmanaged instance", {
                eventInstanceId: instanceId,
                managedInstanceId,
            });
            return;
        }
        // Get instance public IP with retry
        const publicIp = await withRetry(() => getInstancePublicIp(instanceId), 5, // More retries since IP assignment may take time
        2000);
        // Update Cloudflare DNS record with retry
        await withRetry(() => updateCloudflareRecord(publicIp), 3, 1000);
        log("info", "DDNS update completed successfully", {
            instanceId,
            publicIp,
        });
    }
    catch (error) {
        log("error", "DDNS update failed", {
            error: error instanceof Error ? error.message : String(error),
            stack: error instanceof Error ? error.stack : undefined,
        });
        throw error;
    }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvbGFtYmRhL2RkbnMtdXBkYXRlci9pbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFDQSxPQUFPLEVBQUUsU0FBUyxFQUFFLHdCQUF3QixFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDMUUsT0FBTyxFQUFFLFNBQVMsRUFBRSxtQkFBbUIsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBb0NyRSx5Q0FBeUM7QUFDekMsTUFBTSxTQUFTLEdBQUcsSUFBSSxTQUFTLENBQUMsRUFBRSxDQUFDLENBQUM7QUFDcEMsTUFBTSxTQUFTLEdBQUcsSUFBSSxTQUFTLENBQUMsRUFBRSxDQUFDLENBQUM7QUFFcEMscUJBQXFCO0FBQ3JCLFNBQVMsVUFBVTtJQUNqQixNQUFNLG9CQUFvQixHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsc0JBQXNCLENBQUM7SUFDaEUsTUFBTSxnQkFBZ0IsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLGtCQUFrQixDQUFDO0lBQ3hELE1BQU0sa0JBQWtCLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxvQkFBb0IsQ0FBQztJQUM1RCxNQUFNLGNBQWMsR0FBNEI7UUFDOUMsT0FBTztRQUNQLE1BQU07UUFDTixNQUFNO1FBQ04sT0FBTztLQUNSLENBQUM7SUFDRixNQUFNLFdBQVcsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLFNBQVMsSUFBSSxNQUFNLENBQUM7SUFDcEQsTUFBTSxRQUFRLEdBQUcsY0FBYyxDQUFDLFFBQVEsQ0FBQyxXQUFvQyxDQUFDO1FBQzVFLENBQUMsQ0FBRSxXQUFxQztRQUN4QyxDQUFDLENBQUMsTUFBTSxDQUFDO0lBRVgsSUFBSSxDQUFDLG9CQUFvQixJQUFJLENBQUMsZ0JBQWdCLElBQUksQ0FBQyxrQkFBa0IsRUFBRSxDQUFDO1FBQ3RFLE1BQU0sSUFBSSxLQUFLLENBQUMsd0NBQXdDLENBQUMsQ0FBQztJQUM1RCxDQUFDO0lB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b0NBQW9DLEVBQUU7WUFDaEQsVUFBVTtZQUNWLFFBQVE7U0FDVCxDQUFDLENBQUM7SUFDTCxDQUFDO0lBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztRQUNmLEdBQUcsQ0FBQyxPQUFPLEVBQUUsb0JBQW9CLEVBQUU7WUFDakMsS0FBSyxFQUFFLEtBQUssWUFBWSxLQUFLLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUM7WUFDN0QsS0FBSyxFQUFFLEtBQUssWUFBWSxLQUFLLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLFNBQVM7U0FDeEQsQ0FBQyxDQUFDO1FBQ0gsTUFBTSxLQUFLLENBQUM7SUFDZCxDQUFDO0FBQ0gsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHR5cGUgeyBFdmVudEJyaWRnZUV2ZW50LCBDb250ZXh0IH0gZnJvbSBcImF3cy1sYW1iZGFcIjtcbmltcG9ydCB7IEVDMkNsaWVudCwgRGVzY3JpYmVJbnN0YW5jZXNDb21tYW5kIH0gZnJvbSBcIkBhd3Mtc2RrL2NsaWVudC1lYzJcIjtcbmltcG9ydCB7IFNTTUNsaWVudCwgR2V0UGFyYW1ldGVyQ29tbWFuZCB9IGZyb20gXCJAYXdzLXNkay9jbGllbnQtc3NtXCI7XG5cbi8vIFR5cGUgZGVmaW5pdGlvbnNcbmludGVyZmFjZSBFYzJTdGF0ZUNoYW5nZURldGFpbCB7XG4gIFwiaW5zdGFuY2UtaWRcIjogc3RyaW5nO1xuICBzdGF0ZTogc3RyaW5nO1xufVxuXG50eXBlIEVjMlN0YXRlQ2hhbmdlRXZlbnQgPSBFdmVudEJyaWRnZUV2ZW50PFxuICBcIkVDMiBJbnN0YW5jZSBTdGF0ZS1jaGFuZ2UgTm90aWZpY2F0aW9uXCIsXG4gIEVjMlN0YXRlQ2hhbmdlRGV0YWlsXG4+O1xuXG5pbnRlcmZhY2UgRW52Q29uZmlnIHtcbiAgcGFyYW1ldGVyU3RvcmVQcmVmaXg6IHN0cmluZztcbiAgY2xvdWRmbGFyZVpvbmVJZDogc3RyaW5nO1xuICBjbG91ZGZsYXJlUmVjb3JkSWQ6IHN0cmluZztcbiAgbG9nTGV2ZWw6IFwiZGVidWdcIiB8IFwiaW5mb1wiIHwgXCJ3YXJuXCIgfCBcImVycm9yXCI7XG59XG5cbmludGVyZmFjZSBDbG91ZGZsYXJlUmVzcG9uc2U8VD4ge1xuICBzdWNjZXNzOiBib29sZWFuO1xuICBlcnJvcnM6IEFycmF5PHsgY29kZTogbnVtYmVyOyBtZXNzYWdlOiBzdHJpbmcgfT47XG4gIG1lc3NhZ2VzOiBzdHJpbmdbXTtcbiAgcmVzdWx0OiBUO1xufVxuXG5pbnRlcmZhY2UgRG5zUmVjb3JkIHtcbiAgaWQ6IHN0cmluZztcbiAgdHlwZTogc3RyaW5nO1xuICBuYW1lOiBzdHJpbmc7XG4gIGNvbnRlbnQ6IHN0cmluZztcbiAgdHRsOiBudW1iZXI7XG4gIHByb3hpZWQ6IGJvb2xlYW47XG59XG5cbi8vIEluaXRpYWxpemUgQVdTIGNsaWVudHMgYXQgbW9kdWxlIGxldmVsXG5jb25zdCBlYzJDbGllbnQgPSBuZXcgRUMyQ2xpZW50KHt9KTtcbmNvbnN0IHNzbUNsaWVudCA9IG5ldyBTU01DbGllbnQoe30pO1xuXG4vLyBMb2FkIGNvbmZpZ3VyYXRpb25cbmZ1bmN0aW9uIGxvYWRDb25maWcoKTogRW52Q29uZmlnIHtcbiAgY29uc3QgcGFyYW1ldGVyU3RvcmVQcmVmaXggPSBwcm9jZXNzLmVudi5QQVJBTUVURVJfU1RPUkVfUFJFRklYO1xuICBjb25zdCBjbG91ZGZsYXJlWm9uZUlkID0gcHJvY2Vzcy5lbnYuQ0xPVURGTEFSRV9aT05FX0lEO1xuICBjb25zdCBjbG91ZGZsYXJlUmVjb3JkSWQgPSBwcm9jZXNzLmVudi5DTE9VREZMQVJFX1JFQ09SRF9JRDtcbiAgY29uc3QgdmFsaWRMb2dMZXZlbHM6IEVudkNvbmZpZ1tcImxvZ0xldmVsXCJdW10gPSBbXG4gICAgXCJkZWJ1Z1wiLFxuICAgIFwiaW5mb1wiLFxuICAgIFwid2FyblwiLFxuICAgIFwiZXJyb3JcIixcbiAgXTtcbiAgY29uc3QgcmF3TG9nTGV2ZWwgPSBwcm9jZXNzLmVudi5MT0dfTEVWRUwgPz8gXCJpbmZvXCI7XG4gIGNvbnN0IGxvZ0xldmVsID0gdmFsaWRMb2dMZXZlbHMuaW5jbHVkZXMocmF3TG9nTGV2ZWwgYXMgRW52Q29uZmlnW1wibG9nTGV2ZWxcIl0pXG4gICAgPyAocmF3TG9nTGV2ZWwgYXMgRW52Q29uZmlnW1wibG9nTGV2ZWxcIl0pXG4gICAgOiBcImluZm9cIjtcblxuICBpZiAoIXBhcmFtZXRlclN0b3JlUHJlZml4IHx8ICFjbG91ZGZsYXJlWm9uZUlkIHx8ICFjbG91ZGZsYXJlUmVjb3JkSWQpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoXCJNaXNzaW5nIHJlcXVpcmVkIGVudmlyb25tZW50IHZhcmlhYmxlc1wiKTtcbiAgfVxuXG4gIHJldHVybiB7XG4gICAgcGFyYW1ldGVyU3RvcmVQcmVmaXgsXG4gICAgY2xvdWRmbGFyZVpvbmVJZCxcbiAgICBjbG91ZGZsYXJlUmVjb3JkSWQsXG4gICAgbG9nTGV2ZWwsXG4gIH07XG59XG5cbmNvbnN0IGNvbmZpZyA9IGxvYWRDb25maWcoKTtcblxuLy8gTG9nZ2VyIHV0aWxpdHlcbmZ1bmN0aW9uIGxvZyhcbiAgbGV2ZWw6IHN0cmluZyxcbiAgbWVzc2FnZTogc3RyaW5nLFxuICBkYXRhPzogUmVjb3JkPHN0cmluZywgdW5rbm93bj4sXG4pOiB2b2lkIHtcbiAgY29uc3QgbGV2ZWxzID0gW1wiZGVidWdcIiwgXCJpbmZvXCIsIFwid2FyblwiLCBcImVycm9yXCJdO1xuICBjb25zdCBjb25maWdMZXZlbEluZGV4ID0gbGV2ZWxzLmluZGV4T2YoY29uZmlnLmxvZ0xldmVsKTtcbiAgY29uc3QgbWVzc2FnZUxldmVsSW5kZXggPSBsZXZlbHMuaW5kZXhPZihsZXZlbCk7XG5cbiAgaWYgKG1lc3NhZ2VMZXZlbEluZGV4ID49IGNvbmZpZ0xldmVsSW5kZXgpIHtcbiAgICBjb25zb2xlLmxvZyhcbiAgICAgIEpTT04uc3RyaW5naWZ5KHtcbiAgICAgICAgbGV2ZWwsXG4gICAgICAgIG1lc3NhZ2UsXG4gICAgICAgIC4uLmRhdGEsXG4gICAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpLFxuICAgICAgfSksXG4gICAgKTtcbiAgfVxufVxuXG4vLyBHZXQgcGFyYW1ldGVyIGZyb20gUGFyYW1ldGVyIFN0b3JlXG5hc3luYyBmdW5jdGlvbiBnZXRQYXJhbWV0ZXIobmFtZTogc3RyaW5nKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgY29uc3QgY29tbWFuZCA9IG5ldyBHZXRQYXJhbWV0ZXJDb21tYW5kKHtcbiAgICBOYW1lOiBuYW1lLFxuICAgIFdpdGhEZWNyeXB0aW9uOiB0cnVlLFxuICB9KTtcblxuICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHNzbUNsaWVudC5zZW5kKGNvbW1hbmQpO1xuXG4gIGlmICghcmVzcG9uc2UuUGFyYW1ldGVyPy5WYWx1ZSkge1xuICAgIHRocm93IG5ldyBFcnJvcihgUGFyYW1ldGVyIG5vdCBmb3VuZDogJHtuYW1lfWApO1xuICB9XG5cbiAgcmV0dXJuIHJlc3BvbnNlLlBhcmFtZXRlci5WYWx1ZTtcbn1cblxuLy8gR2V0IEVDMiBpbnN0YW5jZSBwdWJsaWMgSVBcbmFzeW5jIGZ1bmN0aW9uIGdldEluc3RhbmNlUHVibGljSXAoaW5zdGFuY2VJZDogc3RyaW5nKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgbG9nKFwiZGVidWdcIiwgXCJHZXR0aW5nIHB1YmxpYyBJUCBmb3IgaW5zdGFuY2VcIiwgeyBpbnN0YW5jZUlkIH0pO1xuXG4gIGNvbnN0IGNvbW1hbmQgPSBuZXcgRGVzY3JpYmVJbnN0YW5jZXNDb21tYW5kKHtcbiAgICBJbnN0YW5jZUlkczogW2luc3RhbmNlSWRdLFxuICB9KTtcblxuICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGVjMkNsaWVudC5zZW5kKGNvbW1hbmQpO1xuICBjb25zdCBpbnN0YW5jZSA9IHJlc3BvbnNlLlJlc2VydmF0aW9ucz8uWzBdPy5JbnN0YW5jZXM/LlswXTtcblxuICBpZiAoIWluc3RhbmNlKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBJbnN0YW5jZSBub3QgZm91bmQ6ICR7aW5zdGFuY2VJZH1gKTtcbiAgfVxuXG4gIGNvbnN0IHB1YmxpY0lwID0gaW5zdGFuY2UuUHVibGljSXBBZGRyZXNzO1xuICBpZiAoIXB1YmxpY0lwKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBJbnN0YW5jZSAke2luc3RhbmNlSWR9IGRvZXMgbm90IGhhdmUgYSBwdWJsaWMgSVBgKTtcbiAgfVxuXG4gIGxvZyhcImluZm9cIiwgXCJSZXRyaWV2ZWQgaW5zdGFuY2UgcHVibGljIElQXCIsIHsgaW5zdGFuY2VJZCwgcHVibGljSXAgfSk7XG4gIHJldHVybiBwdWJsaWNJcDtcbn1cblxuLy8gVXBkYXRlIENsb3VkZmxhcmUgRE5TIHJlY29yZFxuYXN5bmMgZnVuY3Rpb24gdXBkYXRlQ2xvdWRmbGFyZVJlY29yZChpcDogc3RyaW5nKTogUHJvbWlzZTxEbnNSZWNvcmQ+IHtcbiAgbG9nKFwiaW5mb1wiLCBcIlVwZGF0aW5nIENsb3VkZmxhcmUgRE5TIHJlY29yZFwiLCB7XG4gICAgem9uZUlkOiBjb25maWcuY2xvdWRmbGFyZVpvbmVJZCxcbiAgICByZWNvcmRJZDogY29uZmlnLmNsb3VkZmxhcmVSZWNvcmRJZCxcbiAgICBpcCxcbiAgfSk7XG5cbiAgLy8gR2V0IENsb3VkZmxhcmUgQVBJIHRva2VuIGZyb20gUGFyYW1ldGVyIFN0b3JlXG4gIGNvbnN0IGFwaVRva2VuID0gYXdhaXQgZ2V0UGFyYW1ldGVyKFxuICAgIGAke2NvbmZpZy5wYXJhbWV0ZXJTdG9yZVByZWZpeH0vY2xvdWRmbGFyZS10b2tlbmAsXG4gICk7XG5cbiAgY29uc3QgdXJsID0gYGh0dHBzOi8vYXBpLmNsb3VkZmxhcmUuY29tL2NsaWVudC92NC96b25lcy8ke2NvbmZpZy5jbG91ZGZsYXJlWm9uZUlkfS9kbnNfcmVjb3Jkcy8ke2NvbmZpZy5jbG91ZGZsYXJlUmVjb3JkSWR9YDtcblxuICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGZldGNoKHVybCwge1xuICAgIG1ldGhvZDogXCJQQVRDSFwiLFxuICAgIGhlYWRlcnM6IHtcbiAgICAgIEF1dGhvcml6YXRpb246IGBCZWFyZXIgJHthcGlUb2tlbn1gLFxuICAgICAgXCJDb250ZW50LVR5cGVcIjogXCJhcHBsaWNhdGlvbi9qc29uXCIsXG4gICAgfSxcbiAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7XG4gICAgICBjb250ZW50OiBpcCxcbiAgICB9KSxcbiAgfSk7XG5cbiAgaWYgKCFyZXNwb25zZS5vaykge1xuICAgIGNvbnN0IGVycm9yQm9keSA9IGF3YWl0IHJlc3BvbnNlLnRleHQoKTtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYENsb3VkZmxhcmUgQVBJIGVycm9yOiAke3Jlc3BvbnNlLnN0YXR1c30gLSAke2Vycm9yQm9keX1gKTtcbiAgfVxuXG4gIGNvbnN0IGRhdGEgPSAoYXdhaXQgcmVzcG9uc2UuanNvbigpKSBhcyBDbG91ZGZsYXJlUmVzcG9uc2U8RG5zUmVjb3JkPjtcblxuICBpZiAoIWRhdGEuc3VjY2Vzcykge1xuICAgIHRocm93IG5ldyBFcnJvcihgQ2xvdWRmbGFyZSBBUEkgZmFpbGVkOiAke0pTT04uc3RyaW5naWZ5KGRhdGEuZXJyb3JzKX1gKTtcbiAgfVxuXG4gIGxvZyhcImluZm9cIiwgXCJDbG91ZGZsYXJlIEROUyByZWNvcmQgdXBkYXRlZCBzdWNjZXNzZnVsbHlcIiwge1xuICAgIHJlY29yZE5hbWU6IGRhdGEucmVzdWx0Lm5hbWUsXG4gICAgY29udGVudDogZGF0YS5yZXN1bHQuY29udGVudCxcbiAgfSk7XG5cbiAgcmV0dXJuIGRhdGEucmVzdWx0O1xufVxuXG4vLyBSZXRyeSB1dGlsaXR5XG5hc3luYyBmdW5jdGlvbiB3aXRoUmV0cnk8VD4oXG4gIG9wZXJhdGlvbjogKCkgPT4gUHJvbWlzZTxUPixcbiAgbWF4QXR0ZW1wdHMgPSAzLFxuICBiYXNlRGVsYXlNcyA9IDEwMDAsXG4pOiBQcm9taXNlPFQ+IHtcbiAgbGV0IGxhc3RFcnJvcjogRXJyb3IgfCB1bmRlZmluZWQ7XG5cbiAgZm9yIChsZXQgYXR0ZW1wdCA9IDE7IGF0dGVtcHQgPD0gbWF4QXR0ZW1wdHM7IGF0dGVtcHQrKykge1xuICAgIHRyeSB7XG4gICAgICByZXR1cm4gYXdhaXQgb3BlcmF0aW9uKCk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGxhc3RFcnJvciA9IGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvciA6IG5ldyBFcnJvcihTdHJpbmcoZXJyb3IpKTtcbiAgICAgIGxvZyhcIndhcm5cIiwgYE9wZXJhdGlvbiBmYWlsZWQsIGF0dGVtcHQgJHthdHRlbXB0fS8ke21heEF0dGVtcHRzfWAsIHtcbiAgICAgICAgZXJyb3I6IGxhc3RFcnJvci5tZXNzYWdlLFxuICAgICAgfSk7XG5cbiAgICAgIGlmIChhdHRlbXB0IDwgbWF4QXR0ZW1wdHMpIHtcbiAgICAgICAgY29uc3QgZGVsYXkgPSBiYXNlRGVsYXlNcyAqIE1hdGgucG93KDIsIGF0dGVtcHQgLSAxKTtcbiAgICAgICAgYXdhaXQgbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHNldFRpbWVvdXQocmVzb2x2ZSwgZGVsYXkpKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICB0aHJvdyBsYXN0RXJyb3I7XG59XG5cbi8vIE1haW4gaGFuZGxlclxuZXhwb3J0IGNvbnN0IGhhbmRsZXIgPSBhc3luYyAoXG4gIGV2ZW50OiBFYzJTdGF0ZUNoYW5nZUV2ZW50LFxuICBjb250ZXh0OiBDb250ZXh0LFxuKTogUHJvbWlzZTx2b2lkPiA9PiB7XG4gIGxvZyhcImluZm9cIiwgXCJFQzIgc3RhdGUgY2hhbmdlIGV2ZW50IHJlY2VpdmVkXCIsIHtcbiAgICByZXF1ZXN0SWQ6IGNvbnRleHQuYXdzUmVxdWVzdElkLFxuICAgIGluc3RhbmNlSWQ6IGV2ZW50LmRldGFpbFtcImluc3RhbmNlLWlkXCJdLFxuICAgIHN0YXRlOiBldmVudC5kZXRhaWwuc3RhdGUsXG4gIH0pO1xuXG4gIHRyeSB7XG4gICAgY29uc3QgaW5zdGFuY2VJZCA9IGV2ZW50LmRldGFpbFtcImluc3RhbmNlLWlkXCJdO1xuXG4gICAgLy8gT25seSBwcm9jZXNzIHJ1bm5pbmcgc3RhdGVcbiAgICBpZiAoZXZlbnQuZGV0YWlsLnN0YXRlICE9PSBcInJ1bm5pbmdcIikge1xuICAgICAgbG9nKFwiaW5mb1wiLCBcIklnbm9yaW5nIG5vbi1ydW5uaW5nIHN0YXRlXCIsIHsgc3RhdGU6IGV2ZW50LmRldGFpbC5zdGF0ZSB9KTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICAvLyBHZXQgY3VycmVudCBtYW5hZ2VkIGluc3RhbmNlIElEIGZyb20gUGFyYW1ldGVyIFN0b3JlXG4gICAgY29uc3QgbWFuYWdlZEluc3RhbmNlSWQgPSBhd2FpdCBnZXRQYXJhbWV0ZXIoXG4gICAgICBgJHtjb25maWcucGFyYW1ldGVyU3RvcmVQcmVmaXh9L2luc3RhbmNlLWlkYCxcbiAgICApO1xuXG4gICAgLy8gT25seSB1cGRhdGUgRE5TIGZvciBvdXIgbWFuYWdlZCBpbnN0YW5jZVxuICAgIGlmIChtYW5hZ2VkSW5zdGFuY2VJZCAhPT0gaW5zdGFuY2VJZCkge1xuICAgICAgbG9nKFwiaW5mb1wiLCBcIklnbm9yaW5nIHVubWFuYWdlZCBpbnN0YW5jZVwiLCB7XG4gICAgICAgIGV2ZW50SW5zdGFuY2VJZDogaW5zdGFuY2VJZCxcbiAgICAgICAgbWFuYWdlZEluc3RhbmNlSWQsXG4gICAgICB9KTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICAvLyBHZXQgaW5zdGFuY2UgcHVibGljIElQIHdpdGggcmV0cnlcbiAgICBjb25zdCBwdWJsaWNJcCA9IGF3YWl0IHdpdGhSZXRyeShcbiAgICAgICgpID0+IGdldEluc3RhbmNlUHVibGljSXAoaW5zdGFuY2VJZCksXG4gICAgICA1LCAvLyBNb3JlIHJldHJpZXMgc2luY2UgSVAgYXNzaWdubWVudCBtYXkgdGFrZSB0aW1lXG4gICAgICAyMDAwLFxuICAgICk7XG5cbiAgICAvLyBVcGRhdGUgQ2xvdWRmbGFyZSBETlMgcmVjb3JkIHdpdGggcmV0cnlcbiAgICBhd2FpdCB3aXRoUmV0cnkoKCkgPT4gdXBkYXRlQ2xvdWRmbGFyZVJlY29yZChwdWJsaWNJcCksIDMsIDEwMDApO1xuXG4gICAgbG9nKFwiaW5mb1wiLCBcIkRETlMgdXBkYXRlIGNvbXBsZXRlZCBzdWNjZXNzZnVsbHlcIiwge1xuICAgICAgaW5zdGFuY2VJZCxcbiAgICAgIHB1YmxpY0lwLFxuICAgIH0pO1xuICB9IGNhdGNoIChlcnJvcikge1xuICAgIGxvZyhcImVycm9yXCIsIFwiREROUyB1cGRhdGUgZmFpbGVkXCIsIHtcbiAgICAgIGVycm9yOiBlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6IFN0cmluZyhlcnJvciksXG4gICAgICBzdGFjazogZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLnN0YWNrIDogdW5kZWZpbmVkLFxuICAgIH0pO1xuICAgIHRocm93IGVycm9yO1xuICB9XG59O1xuIl19