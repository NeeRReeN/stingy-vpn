import { EC2Client, RunInstancesCommand, DescribeInstancesCommand, } from "@aws-sdk/client-ec2";
import { SSMClient, GetParameterCommand, PutParameterCommand, } from "@aws-sdk/client-ssm";
// Initialize AWS clients at module level (reuse across invocations)
const ec2Client = new EC2Client({});
const ssmClient = new SSMClient({});
// Load configuration from environment variables
function loadConfig() {
    const parameterStorePrefix = process.env.PARAMETER_STORE_PREFIX;
    const subnetId = process.env.SUBNET_ID;
    const launchTemplateId = process.env.LAUNCH_TEMPLATE_ID;
    const validLogLevels = [
        "debug",
        "info",
        "warn",
        "error",
    ];
    const rawLogLevel = process.env.LOG_LEVEL ?? "info";
    const logLevel = validLogLevels.includes(rawLogLevel)
        ? rawLogLevel
        : "info";
    if (!parameterStorePrefix || !subnetId || !launchTemplateId) {
        throw new Error("Missing required environment variables");
    }
    return {
        parameterStorePrefix,
        subnetId,
        launchTemplateId,
        logLevel,
    };
}
const config = loadConfig();
// Logger utility
function log(level, message, data) {
    const levels = ["debug", "info", "warn", "error"];
    const configLevelIndex = levels.indexOf(config.logLevel);
    const messageLevelIndex = levels.indexOf(level);
    if (messageLevelIndex >= configLevelIndex) {
        console.log(JSON.stringify({
            level,
            message,
            ...data,
            timestamp: new Date().toISOString(),
        }));
    }
}
// Get parameter from Parameter Store
async function getParameter(name) {
    const command = new GetParameterCommand({
        Name: name,
        WithDecryption: true,
    });
    const response = await ssmClient.send(command);
    if (!response.Parameter?.Value) {
        throw new Error(`Parameter not found: ${name}`);
    }
    return response.Parameter.Value;
}
// Save parameter to Parameter Store
async function putParameter(name, value) {
    const command = new PutParameterCommand({
        Name: name,
        Value: value,
        Overwrite: true,
    });
    await ssmClient.send(command);
    log("info", "Parameter updated", { name, value });
}
// Launch a new spot instance
async function launchNewSpotInstance() {
    log("info", "Launching new spot instance", {
        launchTemplateId: config.launchTemplateId,
        subnetId: config.subnetId,
    });
    const command = new RunInstancesCommand({
        LaunchTemplate: {
            LaunchTemplateId: config.launchTemplateId,
        },
        MinCount: 1,
        MaxCount: 1,
        SubnetId: config.subnetId,
        TagSpecifications: [
            {
                ResourceType: "instance",
                Tags: [
                    { Key: "Name", Value: "stingy-vpn-server" },
                    { Key: "Project", Value: "stingy-vpn" },
                    { Key: "ManagedBy", Value: "Lambda" },
                ],
            },
        ],
    });
    const response = await ec2Client.send(command);
    if (!response.Instances || response.Instances.length === 0) {
        throw new Error("Failed to launch spot instance");
    }
    const newInstanceId = response.Instances[0].InstanceId;
    if (!newInstanceId) {
        throw new Error("Instance ID not returned");
    }
    log("info", "Spot instance launched successfully", {
        instanceId: newInstanceId,
    });
    return newInstanceId;
}
// Wait for instance to be running
async function waitForInstanceRunning(instanceId, maxAttempts = 30) {
    log("info", "Waiting for instance to be running", { instanceId });
    for (let attempt = 1; attempt <= maxAttempts; attempt++) {
        const command = new DescribeInstancesCommand({
            InstanceIds: [instanceId],
        });
        const response = await ec2Client.send(command);
        const instance = response.Reservations?.[0]?.Instances?.[0];
        const state = instance?.State?.Name;
        log("debug", "Instance state check", { instanceId, state, attempt });
        if (state === "running") {
            log("info", "Instance is now running", { instanceId });
            return;
        }
        if (state === "terminated" || state === "shutting-down") {
            throw new Error(`Instance entered terminal state: ${state}`);
        }
        // Wait 10 seconds before next check
        await new Promise((resolve) => setTimeout(resolve, 10000));
    }
    throw new Error(`Instance did not reach running state within ${maxAttempts * 10} seconds`);
}
// Main handler
export const handler = async (event, context) => {
    log("info", "Spot interruption event received", {
        requestId: context.awsRequestId,
        instanceId: event.detail["instance-id"],
        action: event.detail["instance-action"],
    });
    try {
        const interruptedInstanceId = event.detail["instance-id"];
        // Get current instance ID from Parameter Store
        const currentInstanceId = await getParameter(`${config.parameterStorePrefix}/instance-id`);
        // If the instance ID parameter is still in its initial state, ignore the event
        if (currentInstanceId === "initial") {
            log("info", "Instance ID not initialized; ignoring spot interruption event", {
                interruptedInstanceId,
            });
            return;
        }
        // Only process if this is our managed instance
        if (currentInstanceId !== interruptedInstanceId) {
            log("info", "Ignoring interruption for unmanaged instance", {
                interruptedInstanceId,
                currentInstanceId,
            });
            return;
        }
        // Launch a new spot instance
        const newInstanceId = await launchNewSpotInstance();
        // Update instance ID in Parameter Store
        await putParameter(`${config.parameterStorePrefix}/instance-id`, newInstanceId);
        // Wait for instance to be running (optional, but helps ensure DDNS update works)
        await waitForInstanceRunning(newInstanceId);
        log("info", "Recovery completed successfully", {
            oldInstanceId: interruptedInstanceId,
            newInstanceId,
        });
    }
    catch (error) {
        log("error", "Recovery failed", {
            error: error instanceof Error ? error.message : String(error),
            stack: error instanceof Error ? error.stack : undefined,
        });
        throw error;
    }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvbGFtYmRhL3JlY292ZXJ5L2luZGV4LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFDTCxTQUFTLEVBQ1QsbUJBQW1CLEVBQ25CLHdCQUF3QixHQUN6QixNQUFNLHFCQUFxQixDQUFDO0FBQzdCLE9BQU8sRUFDTCxTQUFTLEVBQ1QsbUJBQW1CLEVBQ25CLG1CQUFtQixHQUNwQixNQUFNLHFCQUFxQixDQUFDO0FBb0I3QixvRUFBb0U7QUFDcEUsTUFBTSxTQUFTLEdBQUcsSUFBSSxTQUFTLENBQUMsRUFBRSxDQUFDLENBQUM7QUFDcEMsTUFBTSxTQUFTLEdBQUcsSUFBSSxTQUFTLENBQUMsRUFBRSxDQUFDLENBQUM7QUFFcEMsZ0RBQWdEO0FBQ2hELFNBQVMsVUFBVTtJQUNqQixNQUFNLG9CQUFvQixHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsc0JBQXNCLENBQUM7SUFDaEUsTUFBTSxRQUFRLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUM7SUFDdkMsTUFBTSxnQkFBZ0IsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLGtCQUFrQixDQUFDO0lBQ3hELE1BQU0sY0FBYyxHQUE0QjtRQUM5QyxPQUFPO1FBQ1AsTUFBTTtRQUNOLE1BQU07UUFDTixPQUFPO0tBQ1IsQ0FBQztJQUNGLE1BQU0sV0FBVyxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsU0FBUyxJQUFJLE1BQU0sQ0FBQztJQUNwRCxNQUFNLFFBQVEsR0FBRyxjQUFjLENBQUMsUUFBUSxDQUFDLFdBQW9DLENBQUM7UUFDNUUsQ0FBQyxDQUFFLFdBQXFDO1FBQ3hDLENBQUMsQ0FBQyxNQUFNLENBQUM7SUFFWCxJQUFJLENBQUMsb0JBQW9CLElBQUksQ0FBQyxRQUFRLElBQUksQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO1FBQzVELE1BQU0sSUFBSSxLQUFLLENBQUMsd0NBQXdDLENBQUMs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Q0FBQyxTQUFTO1NBQ3hELENBQUMsQ0FBQztRQUNILE1BQU0sS0FBSyxDQUFDO0lBQ2QsQ0FBQztBQUNILENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB0eXBlIHsgRXZlbnRCcmlkZ2VFdmVudCwgQ29udGV4dCB9IGZyb20gXCJhd3MtbGFtYmRhXCI7XG5pbXBvcnQge1xuICBFQzJDbGllbnQsXG4gIFJ1bkluc3RhbmNlc0NvbW1hbmQsXG4gIERlc2NyaWJlSW5zdGFuY2VzQ29tbWFuZCxcbn0gZnJvbSBcIkBhd3Mtc2RrL2NsaWVudC1lYzJcIjtcbmltcG9ydCB7XG4gIFNTTUNsaWVudCxcbiAgR2V0UGFyYW1ldGVyQ29tbWFuZCxcbiAgUHV0UGFyYW1ldGVyQ29tbWFuZCxcbn0gZnJvbSBcIkBhd3Mtc2RrL2NsaWVudC1zc21cIjtcblxuLy8gVHlwZSBkZWZpbml0aW9uc1xuaW50ZXJmYWNlIFNwb3RJbnRlcnJ1cHRpb25EZXRhaWwge1xuICBcImluc3RhbmNlLWlkXCI6IHN0cmluZztcbiAgXCJpbnN0YW5jZS1hY3Rpb25cIjogc3RyaW5nO1xufVxuXG50eXBlIFNwb3RJbnRlcnJ1cHRpb25FdmVudCA9IEV2ZW50QnJpZGdlRXZlbnQ8XG4gIFwiRUMyIFNwb3QgSW5zdGFuY2UgSW50ZXJydXB0aW9uIFdhcm5pbmdcIixcbiAgU3BvdEludGVycnVwdGlvbkRldGFpbFxuPjtcblxuaW50ZXJmYWNlIEVudkNvbmZpZyB7XG4gIHBhcmFtZXRlclN0b3JlUHJlZml4OiBzdHJpbmc7XG4gIHN1Ym5ldElkOiBzdHJpbmc7XG4gIGxhdW5jaFRlbXBsYXRlSWQ6IHN0cmluZztcbiAgbG9nTGV2ZWw6IFwiZGVidWdcIiB8IFwiaW5mb1wiIHwgXCJ3YXJuXCIgfCBcImVycm9yXCI7XG59XG5cbi8vIEluaXRpYWxpemUgQVdTIGNsaWVudHMgYXQgbW9kdWxlIGxldmVsIChyZXVzZSBhY3Jvc3MgaW52b2NhdGlvbnMpXG5jb25zdCBlYzJDbGllbnQgPSBuZXcgRUMyQ2xpZW50KHt9KTtcbmNvbnN0IHNzbUNsaWVudCA9IG5ldyBTU01DbGllbnQoe30pO1xuXG4vLyBMb2FkIGNvbmZpZ3VyYXRpb24gZnJvbSBlbnZpcm9ubWVudCB2YXJpYWJsZXNcbmZ1bmN0aW9uIGxvYWRDb25maWcoKTogRW52Q29uZmlnIHtcbiAgY29uc3QgcGFyYW1ldGVyU3RvcmVQcmVmaXggPSBwcm9jZXNzLmVudi5QQVJBTUVURVJfU1RPUkVfUFJFRklYO1xuICBjb25zdCBzdWJuZXRJZCA9IHByb2Nlc3MuZW52LlNVQk5FVF9JRDtcbiAgY29uc3QgbGF1bmNoVGVtcGxhdGVJZCA9IHByb2Nlc3MuZW52LkxBVU5DSF9URU1QTEFURV9JRDtcbiAgY29uc3QgdmFsaWRMb2dMZXZlbHM6IEVudkNvbmZpZ1tcImxvZ0xldmVsXCJdW10gPSBbXG4gICAgXCJkZWJ1Z1wiLFxuICAgIFwiaW5mb1wiLFxuICAgIFwid2FyblwiLFxuICAgIFwiZXJyb3JcIixcbiAgXTtcbiAgY29uc3QgcmF3TG9nTGV2ZWwgPSBwcm9jZXNzLmVudi5MT0dfTEVWRUwgPz8gXCJpbmZvXCI7XG4gIGNvbnN0IGxvZ0xldmVsID0gdmFsaWRMb2dMZXZlbHMuaW5jbHVkZXMocmF3TG9nTGV2ZWwgYXMgRW52Q29uZmlnW1wibG9nTGV2ZWxcIl0pXG4gICAgPyAocmF3TG9nTGV2ZWwgYXMgRW52Q29uZmlnW1wibG9nTGV2ZWxcIl0pXG4gICAgOiBcImluZm9cIjtcblxuICBpZiAoIXBhcmFtZXRlclN0b3JlUHJlZml4IHx8ICFzdWJuZXRJZCB8fCAhbGF1bmNoVGVtcGxhdGVJZCkge1xuICAgIHRocm93IG5ldyBFcnJvcihcIk1pc3NpbmcgcmVxdWlyZWQgZW52aXJvbm1lbnQgdmFyaWFibGVzXCIpO1xuICB9XG5cbiAgcmV0dXJuIHtcbiAgICBwYXJhbWV0ZXJTdG9yZVByZWZpeCxcbiAgICBzdWJuZXRJZCxcbiAgICBsYXVuY2hUZW1wbGF0ZUlkLFxuICAgIGxvZ0xldmVsLFxuICB9O1xufVxuXG5jb25zdCBjb25maWcgPSBsb2FkQ29uZmlnKCk7XG5cbi8vIExvZ2dlciB1dGlsaXR5XG5mdW5jdGlvbiBsb2coXG4gIGxldmVsOiBzdHJpbmcsXG4gIG1lc3NhZ2U6IHN0cmluZyxcbiAgZGF0YT86IFJlY29yZDxzdHJpbmcsIHVua25vd24+LFxuKTogdm9pZCB7XG4gIGNvbnN0IGxldmVscyA9IFtcImRlYnVnXCIsIFwiaW5mb1wiLCBcIndhcm5cIiwgXCJlcnJvclwiXTtcbiAgY29uc3QgY29uZmlnTGV2ZWxJbmRleCA9IGxldmVscy5pbmRleE9mKGNvbmZpZy5sb2dMZXZlbCk7XG4gIGNvbnN0IG1lc3NhZ2VMZXZlbEluZGV4ID0gbGV2ZWxzLmluZGV4T2YobGV2ZWwpO1xuXG4gIGlmIChtZXNzYWdlTGV2ZWxJbmRleCA+PSBjb25maWdMZXZlbEluZGV4KSB7XG4gICAgY29uc29sZS5sb2coXG4gICAgICBKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgIGxldmVsLFxuICAgICAgICBtZXNzYWdlLFxuICAgICAgICAuLi5kYXRhLFxuICAgICAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSxcbiAgICAgIH0pLFxuICAgICk7XG4gIH1cbn1cblxuLy8gR2V0IHBhcmFtZXRlciBmcm9tIFBhcmFtZXRlciBTdG9yZVxuYXN5bmMgZnVuY3Rpb24gZ2V0UGFyYW1ldGVyKG5hbWU6IHN0cmluZyk6IFByb21pc2U8c3RyaW5nPiB7XG4gIGNvbnN0IGNvbW1hbmQgPSBuZXcgR2V0UGFyYW1ldGVyQ29tbWFuZCh7XG4gICAgTmFtZTogbmFtZSxcbiAgICBXaXRoRGVjcnlwdGlvbjogdHJ1ZSxcbiAgfSk7XG5cbiAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBzc21DbGllbnQuc2VuZChjb21tYW5kKTtcblxuICBpZiAoIXJlc3BvbnNlLlBhcmFtZXRlcj8uVmFsdWUpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYFBhcmFtZXRlciBub3QgZm91bmQ6ICR7bmFtZX1gKTtcbiAgfVxuXG4gIHJldHVybiByZXNwb25zZS5QYXJhbWV0ZXIuVmFsdWU7XG59XG5cbi8vIFNhdmUgcGFyYW1ldGVyIHRvIFBhcmFtZXRlciBTdG9yZVxuYXN5bmMgZnVuY3Rpb24gcHV0UGFyYW1ldGVyKG5hbWU6IHN0cmluZywgdmFsdWU6IHN0cmluZyk6IFByb21pc2U8dm9pZD4ge1xuICBjb25zdCBjb21tYW5kID0gbmV3IFB1dFBhcmFtZXRlckNvbW1hbmQoe1xuICAgIE5hbWU6IG5hbWUsXG4gICAgVmFsdWU6IHZhbHVlLFxuICAgIE92ZXJ3cml0ZTogdHJ1ZSxcbiAgfSk7XG5cbiAgYXdhaXQgc3NtQ2xpZW50LnNlbmQoY29tbWFuZCk7XG4gIGxvZyhcImluZm9cIiwgXCJQYXJhbWV0ZXIgdXBkYXRlZFwiLCB7IG5hbWUsIHZhbHVlIH0pO1xufVxuXG4vLyBMYXVuY2ggYSBuZXcgc3BvdCBpbnN0YW5jZVxuYXN5bmMgZnVuY3Rpb24gbGF1bmNoTmV3U3BvdEluc3RhbmNlKCk6IFByb21pc2U8c3RyaW5nPiB7XG4gIGxvZyhcImluZm9cIiwgXCJMYXVuY2hpbmcgbmV3IHNwb3QgaW5zdGFuY2VcIiwge1xuICAgIGxhdW5jaFRlbXBsYXRlSWQ6IGNvbmZpZy5sYXVuY2hUZW1wbGF0ZUlkLFxuICAgIHN1Ym5ldElkOiBjb25maWcuc3VibmV0SWQsXG4gIH0pO1xuXG4gIGNvbnN0IGNvbW1hbmQgPSBuZXcgUnVuSW5zdGFuY2VzQ29tbWFuZCh7XG4gICAgTGF1bmNoVGVtcGxhdGU6IHtcbiAgICAgIExhdW5jaFRlbXBsYXRlSWQ6IGNvbmZpZy5sYXVuY2hUZW1wbGF0ZUlkLFxuICAgIH0sXG4gICAgTWluQ291bnQ6IDEsXG4gICAgTWF4Q291bnQ6IDEsXG4gICAgU3VibmV0SWQ6IGNvbmZpZy5zdWJuZXRJZCxcbiAgICBUYWdTcGVjaWZpY2F0aW9uczogW1xuICAgICAge1xuICAgICAgICBSZXNvdXJjZVR5cGU6IFwiaW5zdGFuY2VcIixcbiAgICAgICAgVGFnczogW1xuICAgICAgICAgIHsgS2V5OiBcIk5hbWVcIiwgVmFsdWU6IFwic3Rpbmd5LXZwbi1zZXJ2ZXJcIiB9LFxuICAgICAgICAgIHsgS2V5OiBcIlByb2plY3RcIiwgVmFsdWU6IFwic3Rpbmd5LXZwblwiIH0sXG4gICAgICAgICAgeyBLZXk6IFwiTWFuYWdlZEJ5XCIsIFZhbHVlOiBcIkxhbWJkYVwiIH0sXG4gICAgICAgIF0sXG4gICAgICB9LFxuICAgIF0sXG4gIH0pO1xuXG4gIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgZWMyQ2xpZW50LnNlbmQoY29tbWFuZCk7XG5cbiAgaWYgKCFyZXNwb25zZS5JbnN0YW5jZXMgfHwgcmVzcG9uc2UuSW5zdGFuY2VzLmxlbmd0aCA9PT0gMCkge1xuICAgIHRocm93IG5ldyBFcnJvcihcIkZhaWxlZCB0byBsYXVuY2ggc3BvdCBpbnN0YW5jZVwiKTtcbiAgfVxuXG4gIGNvbnN0IG5ld0luc3RhbmNlSWQgPSByZXNwb25zZS5JbnN0YW5jZXNbMF0uSW5zdGFuY2VJZDtcbiAgaWYgKCFuZXdJbnN0YW5jZUlkKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKFwiSW5zdGFuY2UgSUQgbm90IHJldHVybmVkXCIpO1xuICB9XG5cbiAgbG9nKFwiaW5mb1wiLCBcIlNwb3QgaW5zdGFuY2UgbGF1bmNoZWQgc3VjY2Vzc2Z1bGx5XCIsIHtcbiAgICBpbnN0YW5jZUlkOiBuZXdJbnN0YW5jZUlkLFxuICB9KTtcbiAgcmV0dXJuIG5ld0luc3RhbmNlSWQ7XG59XG5cbi8vIFdhaXQgZm9yIGluc3RhbmNlIHRvIGJlIHJ1bm5pbmdcbmFzeW5jIGZ1bmN0aW9uIHdhaXRGb3JJbnN0YW5jZVJ1bm5pbmcoXG4gIGluc3RhbmNlSWQ6IHN0cmluZyxcbiAgbWF4QXR0ZW1wdHMgPSAzMCxcbik6IFByb21pc2U8dm9pZD4ge1xuICBsb2coXCJpbmZvXCIsIFwiV2FpdGluZyBmb3IgaW5zdGFuY2UgdG8gYmUgcnVubmluZ1wiLCB7IGluc3RhbmNlSWQgfSk7XG5cbiAgZm9yIChsZXQgYXR0ZW1wdCA9IDE7IGF0dGVtcHQgPD0gbWF4QXR0ZW1wdHM7IGF0dGVtcHQrKykge1xuICAgIGNvbnN0IGNvbW1hbmQgPSBuZXcgRGVzY3JpYmVJbnN0YW5jZXNDb21tYW5kKHtcbiAgICAgIEluc3RhbmNlSWRzOiBbaW5zdGFuY2VJZF0sXG4gICAgfSk7XG5cbiAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGVjMkNsaWVudC5zZW5kKGNvbW1hbmQpO1xuICAgIGNvbnN0IGluc3RhbmNlID0gcmVzcG9uc2UuUmVzZXJ2YXRpb25zPy5bMF0/Lkluc3RhbmNlcz8uWzBdO1xuICAgIGNvbnN0IHN0YXRlID0gaW5zdGFuY2U/LlN0YXRlPy5OYW1lO1xuXG4gICAgbG9nKFwiZGVidWdcIiwgXCJJbnN0YW5jZSBzdGF0ZSBjaGVja1wiLCB7IGluc3RhbmNlSWQsIHN0YXRlLCBhdHRlbXB0IH0pO1xuXG4gICAgaWYgKHN0YXRlID09PSBcInJ1bm5pbmdcIikge1xuICAgICAgbG9nKFwiaW5mb1wiLCBcIkluc3RhbmNlIGlzIG5vdyBydW5uaW5nXCIsIHsgaW5zdGFuY2VJZCB9KTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpZiAoc3RhdGUgPT09IFwidGVybWluYXRlZFwiIHx8IHN0YXRlID09PSBcInNodXR0aW5nLWRvd25cIikge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBJbnN0YW5jZSBlbnRlcmVkIHRlcm1pbmFsIHN0YXRlOiAke3N0YXRlfWApO1xuICAgIH1cblxuICAgIC8vIFdhaXQgMTAgc2Vjb25kcyBiZWZvcmUgbmV4dCBjaGVja1xuICAgIGF3YWl0IG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiBzZXRUaW1lb3V0KHJlc29sdmUsIDEwMDAwKSk7XG4gIH1cblxuICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgYEluc3RhbmNlIGRpZCBub3QgcmVhY2ggcnVubmluZyBzdGF0ZSB3aXRoaW4gJHttYXhBdHRlbXB0cyAqIDEwfSBzZWNvbmRzYCxcbiAgKTtcbn1cblxuLy8gTWFpbiBoYW5kbGVyXG5leHBvcnQgY29uc3QgaGFuZGxlciA9IGFzeW5jIChcbiAgZXZlbnQ6IFNwb3RJbnRlcnJ1cHRpb25FdmVudCxcbiAgY29udGV4dDogQ29udGV4dCxcbik6IFByb21pc2U8dm9pZD4gPT4ge1xuICBsb2coXCJpbmZvXCIsIFwiU3BvdCBpbnRlcnJ1cHRpb24gZXZlbnQgcmVjZWl2ZWRcIiwge1xuICAgIHJlcXVlc3RJZDogY29udGV4dC5hd3NSZXF1ZXN0SWQsXG4gICAgaW5zdGFuY2VJZDogZXZlbnQuZGV0YWlsW1wiaW5zdGFuY2UtaWRcIl0sXG4gICAgYWN0aW9uOiBldmVudC5kZXRhaWxbXCJpbnN0YW5jZS1hY3Rpb25cIl0sXG4gIH0pO1xuXG4gIHRyeSB7XG4gICAgY29uc3QgaW50ZXJydXB0ZWRJbnN0YW5jZUlkID0gZXZlbnQuZGV0YWlsW1wiaW5zdGFuY2UtaWRcIl07XG5cbiAgICAvLyBHZXQgY3VycmVudCBpbnN0YW5jZSBJRCBmcm9tIFBhcmFtZXRlciBTdG9yZVxuICAgIGNvbnN0IGN1cnJlbnRJbnN0YW5jZUlkID0gYXdhaXQgZ2V0UGFyYW1ldGVyKFxuICAgICAgYCR7Y29uZmlnLnBhcmFtZXRlclN0b3JlUHJlZml4fS9pbnN0YW5jZS1pZGAsXG4gICAgKTtcblxuICAgIC8vIElmIHRoZSBpbnN0YW5jZSBJRCBwYXJhbWV0ZXIgaXMgc3RpbGwgaW4gaXRzIGluaXRpYWwgc3RhdGUsIGlnbm9yZSB0aGUgZXZlbnRcbiAgICBpZiAoY3VycmVudEluc3RhbmNlSWQgPT09IFwiaW5pdGlhbFwiKSB7XG4gICAgICBsb2coXG4gICAgICAgIFwiaW5mb1wiLFxuICAgICAgICBcIkluc3RhbmNlIElEIG5vdCBpbml0aWFsaXplZDsgaWdub3Jpbmcgc3BvdCBpbnRlcnJ1cHRpb24gZXZlbnRcIixcbiAgICAgICAge1xuICAgICAgICAgIGludGVycnVwdGVkSW5zdGFuY2VJZCxcbiAgICAgICAgfSxcbiAgICAgICk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgLy8gT25seSBwcm9jZXNzIGlmIHRoaXMgaXMgb3VyIG1hbmFnZWQgaW5zdGFuY2VcbiAgICBpZiAoY3VycmVudEluc3RhbmNlSWQgIT09IGludGVycnVwdGVkSW5zdGFuY2VJZCkge1xuICAgICAgbG9nKFwiaW5mb1wiLCBcIklnbm9yaW5nIGludGVycnVwdGlvbiBmb3IgdW5tYW5hZ2VkIGluc3RhbmNlXCIsIHtcbiAgICAgICAgaW50ZXJydXB0ZWRJbnN0YW5jZUlkLFxuICAgICAgICBjdXJyZW50SW5zdGFuY2VJZCxcbiAgICAgIH0pO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIC8vIExhdW5jaCBhIG5ldyBzcG90IGluc3RhbmNlXG4gICAgY29uc3QgbmV3SW5zdGFuY2VJZCA9IGF3YWl0IGxhdW5jaE5ld1Nwb3RJbnN0YW5jZSgpO1xuXG4gICAgLy8gVXBkYXRlIGluc3RhbmNlIElEIGluIFBhcmFtZXRlciBTdG9yZVxuICAgIGF3YWl0IHB1dFBhcmFtZXRlcihcbiAgICAgIGAke2NvbmZpZy5wYXJhbWV0ZXJTdG9yZVByZWZpeH0vaW5zdGFuY2UtaWRgLFxuICAgICAgbmV3SW5zdGFuY2VJZCxcbiAgICApO1xuXG4gICAgLy8gV2FpdCBmb3IgaW5zdGFuY2UgdG8gYmUgcnVubmluZyAob3B0aW9uYWwsIGJ1dCBoZWxwcyBlbnN1cmUgREROUyB1cGRhdGUgd29ya3MpXG4gICAgYXdhaXQgd2FpdEZvckluc3RhbmNlUnVubmluZyhuZXdJbnN0YW5jZUlkKTtcblxuICAgIGxvZyhcImluZm9cIiwgXCJSZWNvdmVyeSBjb21wbGV0ZWQgc3VjY2Vzc2Z1bGx5XCIsIHtcbiAgICAgIG9sZEluc3RhbmNlSWQ6IGludGVycnVwdGVkSW5zdGFuY2VJZCxcbiAgICAgIG5ld0luc3RhbmNlSWQsXG4gICAgfSk7XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgbG9nKFwiZXJyb3JcIiwgXCJSZWNvdmVyeSBmYWlsZWRcIiwge1xuICAgICAgZXJyb3I6IGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogU3RyaW5nKGVycm9yKSxcbiAgICAgIHN0YWNrOiBlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3Iuc3RhY2sgOiB1bmRlZmluZWQsXG4gICAgfSk7XG4gICAgdGhyb3cgZXJyb3I7XG4gIH1cbn07XG4iXX0=