import * as cdk from "aws-cdk-lib";
import * as lambda from "aws-cdk-lib/aws-lambda";
import * as lambdaNodejs from "aws-cdk-lib/aws-lambda-nodejs";
import * as iam from "aws-cdk-lib/aws-iam";
import * as logs from "aws-cdk-lib/aws-logs";
import { Construct } from "constructs";
/**
 * DDNS Updater Lambda Construct
 * Updates Cloudflare DNS record with the new EC2 public IP
 */
export class DdnsUpdaterLambdaConstruct extends Construct {
    function;
    constructor(scope, id, props) {
        super(scope, id);
        const logLevel = props.environment === "prod" ? "info" : "debug";
        // Create Lambda function
        this.function = new lambdaNodejs.NodejsFunction(this, "Function", {
            entry: "src/lambda/ddns-updater/index.ts",
            handler: "handler",
            runtime: lambda.Runtime.NODEJS_20_X,
            architecture: lambda.Architecture.ARM_64,
            timeout: cdk.Duration.seconds(30),
            memorySize: 128,
            environment: {
                PARAMETER_STORE_PREFIX: props.parameterStorePrefix,
                CLOUDFLARE_ZONE_ID: props.cloudflareZoneId,
                CLOUDFLARE_RECORD_ID: props.cloudflareRecordId,
                LOG_LEVEL: logLevel,
            },
            bundling: {
                minify: props.environment === "prod",
                sourceMap: props.environment !== "prod",
            },
            logRetention: logs.RetentionDays.TWO_WEEKS,
        });
        // Grant Parameter Store permissions
        this.function.addToRolePolicy(new iam.PolicyStatement({
            effect: iam.Effect.ALLOW,
            actions: ["ssm:GetParameter", "ssm:GetParameters"],
            resources: [
                `arn:aws:ssm:${cdk.Stack.of(this).region}:${cdk.Stack.of(this).account}:parameter${props.parameterStorePrefix}/*`,
            ],
        }));
        // Grant EC2 describe permissions to get instance public IP
        this.function.addToRolePolicy(new iam.PolicyStatement({
            effect: iam.Effect.ALLOW,
            actions: ["ec2:DescribeInstances"],
            resources: ["*"],
        }));
        // Add tags
        cdk.Tags.of(this.function).add("Function", "ddns-updater");
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGRucy11cGRhdGVyLWxhbWJkYS1jb25zdHJ1Y3QuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvY2RrL2xpYi9jb25zdHJ1Y3RzL2RkbnMtdXBkYXRlci1sYW1iZGEtY29uc3RydWN0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sS0FBSyxHQUFHLE1BQU0sYUFBYSxDQUFDO0FBQ25DLE9BQU8sS0FBSyxNQUFNLE1BQU0sd0JBQXdCLENBQUM7QUFDakQsT0FBTyxLQUFLLFlBQVksTUFBTSwrQkFBK0IsQ0FBQztBQUM5RCxPQUFPLEtBQUssR0FBRyxNQUFNLHFCQUFxQixDQUFDO0FBQzNDLE9BQU8sS0FBSyxJQUFJLE1BQU0sc0JBQXNCLENBQUM7QUFDN0MsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLFlBQVksQ0FBQztBQWV2Qzs7O0dBR0c7QUFDSCxNQUFNLE9BQU8sMEJBQTJCLFNBQVEsU0FBUztJQUN2QyxRQUFRLENBQWtCO0lBRTFDLFlBQ0UsS0FBZ0IsRUFDaEIsRUFBVSxFQUNWLEtBQXNDO1FBRXRDLEtBQUssQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFFakIsTUFBTSxRQUFRLEdBQUcsS0FBSyxDQUFDLFdBQVcsS0FBSyxNQUFNLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDO1FBRWpFLHlCQUF5QjtRQUN6QixJQUFJLENBQUMsUUFBUSxHQUFHLElBQUksWUFBWSxDQUFDLGNBQWMsQ0FBQyxJQUFJLEVBQUUsVUFBVSxFQUFFO1lBQ2hFLEtBQUssRUFBRSxrQ0FBa0M7WUFDekMsT0FBTyxFQUFFLFNBQVM7WUFDbEIsT0FBTyxFQUFFLE1BQU0sQ0FBQyxPQUFPLENBQUMsV0FBVztZQUNuQyxZQUFZLEVBQUUsTUFBTSxDQUFDLFlBQVksQ0FBQyxNQUFNO1lBQ3hDLE9BQU8sRUFBRSxHQUFHLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUM7WUFDakMsVUFBVSxFQUFFLEdBQUc7WUFDZixXQUFXLEVBQUU7Z0JBQ1gsc0JBQXNCLEVBQUUsS0FBSyxDQUFDLG9CQUFvQjtnQkFDbEQsa0JBQWtCLEVBQUUsS0FBSyxDQUFDLGdCQUFnQjtnQkFDMUMsb0JBQW9CLEVBQUUsS0FBSyxDQUFDLGtCQUFrQjtnQkFDOUMsU0FBUyxFQUFFLFFBQVE7YUFDcEI7WUFDRCxRQUFRLEVBQUU7Z0JBQ1IsTUFBTSxFQUFFLEtBQUssQ0FBQyxXQUFXLEtBQUssTUFBTTtnQkFDcEMsU0FBUyxFQUFFLEtBQUssQ0FBQyxXQUFXLEtBQUssTUFBTTthQUN4QztZQUNELFlBQVksRUFBRSxJQUFJLENBQUMsYUFBYSxDQUFDLFNBQVM7U0FDM0MsQ0FBQyxDQUFDO1FBRUgsb0NBQW9DO1FBQ3BDLElBQUksQ0FBQyxRQUFRLENBQUMsZUFBZSxDQUMzQixJQUFJLEdBQUcsQ0FBQyxlQUFlLENBQUM7WUFDdEIsTUFBTSxFQUFFLEdBQUcsQ0FBQyxNQUFNLENBQUMsS0FBSztZQUN4QixPQUFPLEVBQUUsQ0FBQyxrQkFBa0IsRUFBRSxtQkFBbUIsQ0FBQztZQUNsRCxTQUFTLEVBQUU7Z0JBQ1QsZUFBZSxHQUFHLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxNQUFNLElBQUksR0FBRyxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUMsT0FBTyxhQUFhLEtBQUssQ0FBQyxvQkFBb0IsSUFBSTthQUNsSDtTQUNGLENBQUMsQ0FDSCxDQUFDO1FBRUYsMkRBQTJEO1FBQzNELElBQUksQ0FBQyxRQUFRLENBQUMsZUFBZSxDQUMzQixJQUFJLEdBQUcsQ0FBQyxlQUFlLENBQUM7WUFDdEIsTUFBTSxFQUFFLEdBQUcsQ0FBQyxNQUFNLENBQUMsS0FBSztZQUN4QixPQUFPLEVBQUUsQ0FBQyx1QkFBdUIsQ0FBQztZQUNsQyxTQUFTLEVBQUUsQ0FBQyxHQUFHLENBQUM7U0FDakIsQ0FBQyxDQUNILENBQUM7UUFFRixXQUFXO1FBQ1gsR0FBRyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxVQUFVLEVBQUUsY0FBYyxDQUFDLENBQUM7SUFDN0QsQ0FBQztDQUNGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgY2RrIGZyb20gXCJhd3MtY2RrLWxpYlwiO1xuaW1wb3J0ICogYXMgbGFtYmRhIGZyb20gXCJhd3MtY2RrLWxpYi9hd3MtbGFtYmRhXCI7XG5pbXBvcnQgKiBhcyBsYW1iZGFOb2RlanMgZnJvbSBcImF3cy1jZGstbGliL2F3cy1sYW1iZGEtbm9kZWpzXCI7XG5pbXBvcnQgKiBhcyBpYW0gZnJvbSBcImF3cy1jZGstbGliL2F3cy1pYW1cIjtcbmltcG9ydCAqIGFzIGxvZ3MgZnJvbSBcImF3cy1jZGstbGliL2F3cy1sb2dzXCI7XG5pbXBvcnQgeyBDb25zdHJ1Y3QgfSBmcm9tIFwiY29uc3RydWN0c1wiO1xuXG5pbXBvcnQgdHlwZSB7IEVudmlyb25tZW50IH0gZnJvbSBcIi4uLy4uLy4uL2NvbmZpZy90eXBlcy5qc1wiO1xuXG5leHBvcnQgaW50ZXJmYWNlIERkbnNVcGRhdGVyTGFtYmRhQ29uc3RydWN0UHJvcHMge1xuICAvKiogRW52aXJvbm1lbnQgKGRldi9wcm9kKSAqL1xuICByZWFkb25seSBlbnZpcm9ubWVudDogRW52aXJvbm1lbnQ7XG4gIC8qKiBQYXJhbWV0ZXIgU3RvcmUgcHJlZml4ICovXG4gIHJlYWRvbmx5IHBhcmFtZXRlclN0b3JlUHJlZml4OiBzdHJpbmc7XG4gIC8qKiBDbG91ZGZsYXJlIFpvbmUgSUQgKi9cbiAgcmVhZG9ubHkgY2xvdWRmbGFyZVpvbmVJZDogc3RyaW5nO1xuICAvKiogQ2xvdWRmbGFyZSBETlMgUmVjb3JkIElEICovXG4gIHJlYWRvbmx5IGNsb3VkZmxhcmVSZWNvcmRJZDogc3RyaW5nO1xufVxuXG4vKipcbiAqIERETlMgVXBkYXRlciBMYW1iZGEgQ29uc3RydWN0XG4gKiBVcGRhdGVzIENsb3VkZmxhcmUgRE5TIHJlY29yZCB3aXRoIHRoZSBuZXcgRUMyIHB1YmxpYyBJUFxuICovXG5leHBvcnQgY2xhc3MgRGRuc1VwZGF0ZXJMYW1iZGFDb25zdHJ1Y3QgZXh0ZW5kcyBDb25zdHJ1Y3Qge1xuICBwdWJsaWMgcmVhZG9ubHkgZnVuY3Rpb246IGxhbWJkYS5GdW5jdGlvbjtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBzY29wZTogQ29uc3RydWN0LFxuICAgIGlkOiBzdHJpbmcsXG4gICAgcHJvcHM6IERkbnNVcGRhdGVyTGFtYmRhQ29uc3RydWN0UHJvcHMsXG4gICkge1xuICAgIHN1cGVyKHNjb3BlLCBpZCk7XG5cbiAgICBjb25zdCBsb2dMZXZlbCA9IHByb3BzLmVudmlyb25tZW50ID09PSBcInByb2RcIiA/IFwiaW5mb1wiIDogXCJkZWJ1Z1wiO1xuXG4gICAgLy8gQ3JlYXRlIExhbWJkYSBmdW5jdGlvblxuICAgIHRoaXMuZnVuY3Rpb24gPSBuZXcgbGFtYmRhTm9kZWpzLk5vZGVqc0Z1bmN0aW9uKHRoaXMsIFwiRnVuY3Rpb25cIiwge1xuICAgICAgZW50cnk6IFwic3JjL2xhbWJkYS9kZG5zLXVwZGF0ZXIvaW5kZXgudHNcIixcbiAgICAgIGhhbmRsZXI6IFwiaGFuZGxlclwiLFxuICAgICAgcnVudGltZTogbGFtYmRhLlJ1bnRpbWUuTk9ERUpTXzIwX1gsXG4gICAgICBhcmNoaXRlY3R1cmU6IGxhbWJkYS5BcmNoaXRlY3R1cmUuQVJNXzY0LFxuICAgICAgdGltZW91dDogY2RrLkR1cmF0aW9uLnNlY29uZHMoMzApLFxuICAgICAgbWVtb3J5U2l6ZTogMTI4LFxuICAgICAgZW52aXJvbm1lbnQ6IHtcbiAgICAgICAgUEFSQU1FVEVSX1NUT1JFX1BSRUZJWDogcHJvcHMucGFyYW1ldGVyU3RvcmVQcmVmaXgsXG4gICAgICAgIENMT1VERkxBUkVfWk9ORV9JRDogcHJvcHMuY2xvdWRmbGFyZVpvbmVJZCxcbiAgICAgICAgQ0xPVURGTEFSRV9SRUNPUkRfSUQ6IHByb3BzLmNsb3VkZmxhcmVSZWNvcmRJZCxcbiAgICAgICAgTE9HX0xFVkVMOiBsb2dMZXZlbCxcbiAgICAgIH0sXG4gICAgICBidW5kbGluZzoge1xuICAgICAgICBtaW5pZnk6IHByb3BzLmVudmlyb25tZW50ID09PSBcInByb2RcIixcbiAgICAgICAgc291cmNlTWFwOiBwcm9wcy5lbnZpcm9ubWVudCAhPT0gXCJwcm9kXCIsXG4gICAgICB9LFxuICAgICAgbG9nUmV0ZW50aW9uOiBsb2dzLlJldGVudGlvbkRheXMuVFdPX1dFRUtTLFxuICAgIH0pO1xuXG4gICAgLy8gR3JhbnQgUGFyYW1ldGVyIFN0b3JlIHBlcm1pc3Npb25zXG4gICAgdGhpcy5mdW5jdGlvbi5hZGRUb1JvbGVQb2xpY3koXG4gICAgICBuZXcgaWFtLlBvbGljeVN0YXRlbWVudCh7XG4gICAgICAgIGVmZmVjdDogaWFtLkVmZmVjdC5BTExPVyxcbiAgICAgICAgYWN0aW9uczogW1wic3NtOkdldFBhcmFtZXRlclwiLCBcInNzbTpHZXRQYXJhbWV0ZXJzXCJdLFxuICAgICAgICByZXNvdXJjZXM6IFtcbiAgICAgICAgICBgYXJuOmF3czpzc206JHtjZGsuU3RhY2sub2YodGhpcykucmVnaW9ufToke2Nkay5TdGFjay5vZih0aGlzKS5hY2NvdW50fTpwYXJhbWV0ZXIke3Byb3BzLnBhcmFtZXRlclN0b3JlUHJlZml4fS8qYCxcbiAgICAgICAgXSxcbiAgICAgIH0pLFxuICAgICk7XG5cbiAgICAvLyBHcmFudCBFQzIgZGVzY3JpYmUgcGVybWlzc2lvbnMgdG8gZ2V0IGluc3RhbmNlIHB1YmxpYyBJUFxuICAgIHRoaXMuZnVuY3Rpb24uYWRkVG9Sb2xlUG9saWN5KFxuICAgICAgbmV3IGlhbS5Qb2xpY3lTdGF0ZW1lbnQoe1xuICAgICAgICBlZmZlY3Q6IGlhbS5FZmZlY3QuQUxMT1csXG4gICAgICAgIGFjdGlvbnM6IFtcImVjMjpEZXNjcmliZUluc3RhbmNlc1wiXSxcbiAgICAgICAgcmVzb3VyY2VzOiBbXCIqXCJdLFxuICAgICAgfSksXG4gICAgKTtcblxuICAgIC8vIEFkZCB0YWdzXG4gICAgY2RrLlRhZ3Mub2YodGhpcy5mdW5jdGlvbikuYWRkKFwiRnVuY3Rpb25cIiwgXCJkZG5zLXVwZGF0ZXJcIik7XG4gIH1cbn1cbiJdfQ==