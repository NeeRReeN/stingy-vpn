import * as cdk from "aws-cdk-lib";
import * as lambda from "aws-cdk-lib/aws-lambda";
import * as lambdaNodejs from "aws-cdk-lib/aws-lambda-nodejs";
import * as iam from "aws-cdk-lib/aws-iam";
import * as logs from "aws-cdk-lib/aws-logs";
import { Construct } from "constructs";
/**
 * Recovery Lambda Construct
 * Handles spot instance interruption and launches a new instance
 */
export class RecoveryLambdaConstruct extends Construct {
    function;
    constructor(scope, id, props) {
        super(scope, id);
        const logLevel = props.environment === "prod" ? "info" : "debug";
        // Create Lambda function
        this.function = new lambdaNodejs.NodejsFunction(this, "Function", {
            entry: "src/lambda/recovery/index.ts",
            handler: "handler",
            runtime: lambda.Runtime.NODEJS_20_X,
            architecture: lambda.Architecture.ARM_64,
            timeout: cdk.Duration.minutes(5),
            memorySize: 256,
            environment: {
                PARAMETER_STORE_PREFIX: props.parameterStorePrefix,
                VPC_ID: props.vpcId,
                SUBNET_ID: props.subnetId,
                SECURITY_GROUP_ID: props.securityGroupId,
                LAUNCH_TEMPLATE_ID: props.launchTemplateId,
                LOG_LEVEL: logLevel,
            },
            bundling: {
                minify: props.environment === "prod",
                sourceMap: props.environment !== "prod",
            },
            logRetention: logs.RetentionDays.TWO_WEEKS,
        });
        // Grant Parameter Store permissions
        this.function.addToRolePolicy(new iam.PolicyStatement({
            effect: iam.Effect.ALLOW,
            actions: ["ssm:GetParameter", "ssm:GetParameters", "ssm:PutParameter"],
            resources: [
                `arn:aws:ssm:${cdk.Stack.of(this).region}:${cdk.Stack.of(this).account}:parameter${props.parameterStorePrefix}/*`,
            ],
        }));
        // Grant EC2 permissions for spot instance management
        this.function.addToRolePolicy(new iam.PolicyStatement({
            effect: iam.Effect.ALLOW,
            actions: [
                "ec2:RunInstances",
                "ec2:CreateTags",
                "ec2:DescribeInstances",
                "ec2:DescribeSpotInstanceRequests",
            ],
            resources: ["*"],
        }));
        // Grant EC2 launch template permissions
        this.function.addToRolePolicy(new iam.PolicyStatement({
            effect: iam.Effect.ALLOW,
            actions: ["ec2:DescribeLaunchTemplates"],
            resources: ["*"],
        }));
        // Grant IAM pass role permission for EC2 instance profile
        this.function.addToRolePolicy(new iam.PolicyStatement({
            effect: iam.Effect.ALLOW,
            actions: ["iam:PassRole"],
            resources: [props.ec2RoleArn],
            conditions: {
                StringEquals: {
                    "iam:PassedToService": "ec2.amazonaws.com",
                },
            },
        }));
        // Add tags
        cdk.Tags.of(this.function).add("Function", "recovery-handler");
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVjb3ZlcnktbGFtYmRhLWNvbnN0cnVjdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jZGsvbGliL2NvbnN0cnVjdHMvcmVjb3ZlcnktbGFtYmRhLWNvbnN0cnVjdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEtBQUssR0FBRyxNQUFNLGFBQWEsQ0FBQztBQUNuQyxPQUFPLEtBQUssTUFBTSxNQUFNLHdCQUF3QixDQUFDO0FBQ2pELE9BQU8sS0FBSyxZQUFZLE1BQU0sK0JBQStCLENBQUM7QUFDOUQsT0FBTyxLQUFLLEdBQUcsTUFBTSxxQkFBcUIsQ0FBQztBQUMzQyxPQUFPLEtBQUssSUFBSSxNQUFNLHNCQUFzQixDQUFDO0FBQzdDLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxZQUFZLENBQUM7QUFxQnZDOzs7R0FHRztBQUNILE1BQU0sT0FBTyx1QkFBd0IsU0FBUSxTQUFTO0lBQ3BDLFFBQVEsQ0FBa0I7SUFFMUMsWUFDRSxLQUFnQixFQUNoQixFQUFVLEVBQ1YsS0FBbUM7UUFFbkMsS0FBSyxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsQ0FBQztRQUVqQixNQUFNLFFBQVEsR0FBRyxLQUFLLENBQUMsV0FBVyxLQUFLLE1BQU0sQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUM7UUFFakUseUJBQXlCO1FBQ3pCLElBQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSxZQUFZLENBQUMsY0FBYyxDQUFDLElBQUksRUFBRSxVQUFVLEVBQUU7WUFDaEUsS0FBSyxFQUFFLDhCQUE4QjtZQUNyQyxPQUFPLEVBQUUsU0FBUztZQUNsQixPQUFPLEVBQUUsTUFBTSxDQUFDLE9BQU8sQ0FBQyxXQUFXO1lBQ25DLFlBQVksRUFBRSxNQUFNLENBQUMsWUFBWSxDQUFDLE1BQU07WUFDeEMsT0FBTyxFQUFFLEdBQUcsQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQztZQUNoQyxVQUFVLEVBQUUsR0FBRztZQUNmLFdBQVcsRUFBRTtnQkFDWCxzQkFBc0IsRUFBRSxLQUFLLENBQUMsb0JBQW9CO2dCQUNsRCxNQUFNLEVBQUUsS0FBSyxDQUFDLEtBQUs7Z0JBQ25CLFNBQVMsRUFBRSxLQUFLLENBQUMsUUFBUTtnQkFDekIsaUJBQWlCLEVBQUUsS0FBSyxDQUFDLGVBQWU7Z0JBQ3hDLGtCQUFrQixFQUFFLEtBQUssQ0FBQyxnQkFBZ0I7Z0JBQzFDLFNBQVMsRUFBRSxRQUFRO2FBQ3BCO1lBQ0QsUUFBUSxFQUFFO2dCQUNSLE1BQU0sRUFBRSxLQUFLLENBQUMsV0FBVyxLQUFLLE1BQU07Z0JBQ3BDLFNBQVMsRUFBRSxLQUFLLENBQUMsV0FBVyxLQUFLLE1BQU07YUFDeEM7WUFDRCxZQUFZLEVBQUUsSUFBSSxDQUFDLGFBQWEsQ0FBQyxTQUFTO1NBQzNDLENBQUMsQ0FBQztRQUVILG9DQUFvQztRQUNwQyxJQUFJLENBQUMsUUFBUSxDQUFDLGVBQWUsQ0FDM0IsSUFBSSxHQUFHLENBQUMsZUFBZSxDQUFDO1lBQ3RCLE1BQU0sRUFBRSxHQUFHLENBQUMsTUFBTSxDQUFDLEtBQUs7WUFDeEIsT0FBTyxFQUFFLENBQUMsa0JBQWtCLEVBQUUsbUJBQW1CLEVBQUUsa0JBQWtCLENBQUM7WUFDdEUsU0FBUyxFQUFFO2dCQUNULGVBQWUsR0FBRyxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUMsTUFBTSxJQUFJLEdBQUcsQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDLE9BQU8sYUFBYSxLQUFLLENBQUMsb0JBQW9CLElBQUk7YUFDbEg7U0FDRixDQUFDLENBQ0gsQ0FBQztRQUVGLHFEQUFxRDtRQUNyRCxJQUFJLENBQUMsUUFBUSxDQUFDLGVBQWUsQ0FDM0IsSUFBSSxHQUFHLENBQUMsZUFBZSxDQUFDO1lBQ3RCLE1BQU0sRUFBRSxHQUFHLENBQUMsTUFBTSxDQUFDLEtBQUs7WUFDeEIsT0FBTyxFQUFFO2dCQUNQLGtCQUFrQjtnQkFDbEIsZ0JBQWdCO2dCQUNoQix1QkFBdUI7Z0JBQ3ZCLGtDQUFrQzthQUNuQztZQUNELFNBQVMsRUFBRSxDQUFDLEdBQUcsQ0FBQztTQUNqQixDQUFDLENBQ0gsQ0FBQztRQUVGLHdDQUF3QztRQUN4QyxJQUFJLENBQUMsUUFBUSxDQUFDLGVBQWUsQ0FDM0IsSUFBSSxHQUFHLENBQUMsZUFBZSxDQUFDO1lBQ3RCLE1BQU0sRUFBRSxHQUFHLENBQUMsTUFBTSxDQUFDLEtBQUs7WUFDeEIsT0FBTyxFQUFFLENBQUMsNkJBQTZCLENBQUM7WUFDeEMsU0FBUyxFQUFFLENBQUMsR0FBRyxDQUFDO1NBQ2pCLENBQUMsQ0FDSCxDQUFDO1FBRUYsMERBQTBEO1FBQzFELElBQUksQ0FBQyxRQUFRLENBQUMsZUFBZSxDQUMzQixJQUFJLEdBQUcsQ0FBQyxlQUFlLENBQUM7WUFDdEIsTUFBTSxFQUFFLEdBQUcsQ0FBQyxNQUFNLENBQUMsS0FBSztZQUN4QixPQUFPLEVBQUUsQ0FBQyxjQUFjLENBQUM7WUFDekIsU0FBUyxFQUFFLENBQUMsS0FBSyxDQUFDLFVBQVUsQ0FBQztZQUM3QixVQUFVLEVBQUU7Z0JBQ1YsWUFBWSxFQUFFO29CQUNaLHFCQUFxQixFQUFFLG1CQUFtQjtpQkFDM0M7YUFDRjtTQUNGLENBQUMsQ0FDSCxDQUFDO1FBRUYsV0FBVztRQUNYLEdBQUcsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQyxHQUFHLENBQUMsVUFBVSxFQUFFLGtCQUFrQixDQUFDLENBQUM7SUFDakUsQ0FBQztDQUNGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgY2RrIGZyb20gXCJhd3MtY2RrLWxpYlwiO1xuaW1wb3J0ICogYXMgbGFtYmRhIGZyb20gXCJhd3MtY2RrLWxpYi9hd3MtbGFtYmRhXCI7XG5pbXBvcnQgKiBhcyBsYW1iZGFOb2RlanMgZnJvbSBcImF3cy1jZGstbGliL2F3cy1sYW1iZGEtbm9kZWpzXCI7XG5pbXBvcnQgKiBhcyBpYW0gZnJvbSBcImF3cy1jZGstbGliL2F3cy1pYW1cIjtcbmltcG9ydCAqIGFzIGxvZ3MgZnJvbSBcImF3cy1jZGstbGliL2F3cy1sb2dzXCI7XG5pbXBvcnQgeyBDb25zdHJ1Y3QgfSBmcm9tIFwiY29uc3RydWN0c1wiO1xuXG5pbXBvcnQgdHlwZSB7IEVudmlyb25tZW50IH0gZnJvbSBcIi4uLy4uLy4uL2NvbmZpZy90eXBlcy5qc1wiO1xuXG5leHBvcnQgaW50ZXJmYWNlIFJlY292ZXJ5TGFtYmRhQ29uc3RydWN0UHJvcHMge1xuICAvKiogRW52aXJvbm1lbnQgKGRldi9wcm9kKSAqL1xuICByZWFkb25seSBlbnZpcm9ubWVudDogRW52aXJvbm1lbnQ7XG4gIC8qKiBQYXJhbWV0ZXIgU3RvcmUgcHJlZml4ICovXG4gIHJlYWRvbmx5IHBhcmFtZXRlclN0b3JlUHJlZml4OiBzdHJpbmc7XG4gIC8qKiBWUEMgSUQgZm9yIEVDMiBvcGVyYXRpb25zICovXG4gIHJlYWRvbmx5IHZwY0lkOiBzdHJpbmc7XG4gIC8qKiBTdWJuZXQgSUQgZm9yIHNwb3QgaW5zdGFuY2UgbGF1bmNoICovXG4gIHJlYWRvbmx5IHN1Ym5ldElkOiBzdHJpbmc7XG4gIC8qKiBTZWN1cml0eSBncm91cCBJRCBmb3Igc3BvdCBpbnN0YW5jZSAqL1xuICByZWFkb25seSBzZWN1cml0eUdyb3VwSWQ6IHN0cmluZztcbiAgLyoqIExhdW5jaCB0ZW1wbGF0ZSBJRCAqL1xuICByZWFkb25seSBsYXVuY2hUZW1wbGF0ZUlkOiBzdHJpbmc7XG4gIC8qKiBFQzIgaW5zdGFuY2Ugcm9sZSBBUk4gKGZvciBpYW06UGFzc1JvbGUgcmVzdHJpY3Rpb24pICovXG4gIHJlYWRvbmx5IGVjMlJvbGVBcm46IHN0cmluZztcbn1cblxuLyoqXG4gKiBSZWNvdmVyeSBMYW1iZGEgQ29uc3RydWN0XG4gKiBIYW5kbGVzIHNwb3QgaW5zdGFuY2UgaW50ZXJydXB0aW9uIGFuZCBsYXVuY2hlcyBhIG5ldyBpbnN0YW5jZVxuICovXG5leHBvcnQgY2xhc3MgUmVjb3ZlcnlMYW1iZGFDb25zdHJ1Y3QgZXh0ZW5kcyBDb25zdHJ1Y3Qge1xuICBwdWJsaWMgcmVhZG9ubHkgZnVuY3Rpb246IGxhbWJkYS5GdW5jdGlvbjtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBzY29wZTogQ29uc3RydWN0LFxuICAgIGlkOiBzdHJpbmcsXG4gICAgcHJvcHM6IFJlY292ZXJ5TGFtYmRhQ29uc3RydWN0UHJvcHMsXG4gICkge1xuICAgIHN1cGVyKHNjb3BlLCBpZCk7XG5cbiAgICBjb25zdCBsb2dMZXZlbCA9IHByb3BzLmVudmlyb25tZW50ID09PSBcInByb2RcIiA/IFwiaW5mb1wiIDogXCJkZWJ1Z1wiO1xuXG4gICAgLy8gQ3JlYXRlIExhbWJkYSBmdW5jdGlvblxuICAgIHRoaXMuZnVuY3Rpb24gPSBuZXcgbGFtYmRhTm9kZWpzLk5vZGVqc0Z1bmN0aW9uKHRoaXMsIFwiRnVuY3Rpb25cIiwge1xuICAgICAgZW50cnk6IFwic3JjL2xhbWJkYS9yZWNvdmVyeS9pbmRleC50c1wiLFxuICAgICAgaGFuZGxlcjogXCJoYW5kbGVyXCIsXG4gICAgICBydW50aW1lOiBsYW1iZGEuUnVudGltZS5OT0RFSlNfMjBfWCxcbiAgICAgIGFyY2hpdGVjdHVyZTogbGFtYmRhLkFyY2hpdGVjdHVyZS5BUk1fNjQsXG4gICAgICB0aW1lb3V0OiBjZGsuRHVyYXRpb24ubWludXRlcyg1KSxcbiAgICAgIG1lbW9yeVNpemU6IDI1NixcbiAgICAgIGVudmlyb25tZW50OiB7XG4gICAgICAgIFBBUkFNRVRFUl9TVE9SRV9QUkVGSVg6IHByb3BzLnBhcmFtZXRlclN0b3JlUHJlZml4LFxuICAgICAgICBWUENfSUQ6IHByb3BzLnZwY0lkLFxuICAgICAgICBTVUJORVRfSUQ6IHByb3BzLnN1Ym5ldElkLFxuICAgICAgICBTRUNVUklUWV9HUk9VUF9JRDogcHJvcHMuc2VjdXJpdHlHcm91cElkLFxuICAgICAgICBMQVVOQ0hfVEVNUExBVEVfSUQ6IHByb3BzLmxhdW5jaFRlbXBsYXRlSWQsXG4gICAgICAgIExPR19MRVZFTDogbG9nTGV2ZWwsXG4gICAgICB9LFxuICAgICAgYnVuZGxpbmc6IHtcbiAgICAgICAgbWluaWZ5OiBwcm9wcy5lbnZpcm9ubWVudCA9PT0gXCJwcm9kXCIsXG4gICAgICAgIHNvdXJjZU1hcDogcHJvcHMuZW52aXJvbm1lbnQgIT09IFwicHJvZFwiLFxuICAgICAgfSxcbiAgICAgIGxvZ1JldGVudGlvbjogbG9ncy5SZXRlbnRpb25EYXlzLlRXT19XRUVLUyxcbiAgICB9KTtcblxuICAgIC8vIEdyYW50IFBhcmFtZXRlciBTdG9yZSBwZXJtaXNzaW9uc1xuICAgIHRoaXMuZnVuY3Rpb24uYWRkVG9Sb2xlUG9saWN5KFxuICAgICAgbmV3IGlhbS5Qb2xpY3lTdGF0ZW1lbnQoe1xuICAgICAgICBlZmZlY3Q6IGlhbS5FZmZlY3QuQUxMT1csXG4gICAgICAgIGFjdGlvbnM6IFtcInNzbTpHZXRQYXJhbWV0ZXJcIiwgXCJzc206R2V0UGFyYW1ldGVyc1wiLCBcInNzbTpQdXRQYXJhbWV0ZXJcIl0sXG4gICAgICAgIHJlc291cmNlczogW1xuICAgICAgICAgIGBhcm46YXdzOnNzbToke2Nkay5TdGFjay5vZih0aGlzKS5yZWdpb259OiR7Y2RrLlN0YWNrLm9mKHRoaXMpLmFjY291bnR9OnBhcmFtZXRlciR7cHJvcHMucGFyYW1ldGVyU3RvcmVQcmVmaXh9LypgLFxuICAgICAgICBdLFxuICAgICAgfSksXG4gICAgKTtcblxuICAgIC8vIEdyYW50IEVDMiBwZXJtaXNzaW9ucyBmb3Igc3BvdCBpbnN0YW5jZSBtYW5hZ2VtZW50XG4gICAgdGhpcy5mdW5jdGlvbi5hZGRUb1JvbGVQb2xpY3koXG4gICAgICBuZXcgaWFtLlBvbGljeVN0YXRlbWVudCh7XG4gICAgICAgIGVmZmVjdDogaWFtLkVmZmVjdC5BTExPVyxcbiAgICAgICAgYWN0aW9uczogW1xuICAgICAgICAgIFwiZWMyOlJ1bkluc3RhbmNlc1wiLFxuICAgICAgICAgIFwiZWMyOkNyZWF0ZVRhZ3NcIixcbiAgICAgICAgICBcImVjMjpEZXNjcmliZUluc3RhbmNlc1wiLFxuICAgICAgICAgIFwiZWMyOkRlc2NyaWJlU3BvdEluc3RhbmNlUmVxdWVzdHNcIixcbiAgICAgICAgXSxcbiAgICAgICAgcmVzb3VyY2VzOiBbXCIqXCJdLFxuICAgICAgfSksXG4gICAgKTtcblxuICAgIC8vIEdyYW50IEVDMiBsYXVuY2ggdGVtcGxhdGUgcGVybWlzc2lvbnNcbiAgICB0aGlzLmZ1bmN0aW9uLmFkZFRvUm9sZVBvbGljeShcbiAgICAgIG5ldyBpYW0uUG9saWN5U3RhdGVtZW50KHtcbiAgICAgICAgZWZmZWN0OiBpYW0uRWZmZWN0LkFMTE9XLFxuICAgICAgICBhY3Rpb25zOiBbXCJlYzI6RGVzY3JpYmVMYXVuY2hUZW1wbGF0ZXNcIl0sXG4gICAgICAgIHJlc291cmNlczogW1wiKlwiXSxcbiAgICAgIH0pLFxuICAgICk7XG5cbiAgICAvLyBHcmFudCBJQU0gcGFzcyByb2xlIHBlcm1pc3Npb24gZm9yIEVDMiBpbnN0YW5jZSBwcm9maWxlXG4gICAgdGhpcy5mdW5jdGlvbi5hZGRUb1JvbGVQb2xpY3koXG4gICAgICBuZXcgaWFtLlBvbGljeVN0YXRlbWVudCh7XG4gICAgICAgIGVmZmVjdDogaWFtLkVmZmVjdC5BTExPVyxcbiAgICAgICAgYWN0aW9uczogW1wiaWFtOlBhc3NSb2xlXCJdLFxuICAgICAgICByZXNvdXJjZXM6IFtwcm9wcy5lYzJSb2xlQXJuXSxcbiAgICAgICAgY29uZGl0aW9uczoge1xuICAgICAgICAgIFN0cmluZ0VxdWFsczoge1xuICAgICAgICAgICAgXCJpYW06UGFzc2VkVG9TZXJ2aWNlXCI6IFwiZWMyLmFtYXpvbmF3cy5jb21cIixcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgfSksXG4gICAgKTtcblxuICAgIC8vIEFkZCB0YWdzXG4gICAgY2RrLlRhZ3Mub2YodGhpcy5mdW5jdGlvbikuYWRkKFwiRnVuY3Rpb25cIiwgXCJyZWNvdmVyeS1oYW5kbGVyXCIpO1xuICB9XG59XG4iXX0=